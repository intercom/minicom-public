#!/usr/bin/env ruby

gemfile = File.read("./Gemfile")
REQUIRED_RUBY_VERSION = gemfile[/ruby ['"]([\d\.]+)['"]/, 1]
ACTUAL_RUBY_VERSION = RUBY_VERSION

HOMEBREW_INSTALLATION_COMMAND = '/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"'
RY_INSTALLATION_COMMAND = "brew update && brew install ry"

RUBY_VERSION_MANAGER_INSTALLATION_INSTRUCTIONS = {
  "rbenv" => {
    "install" => "rbenv install #{REQUIRED_RUBY_VERSION}",
    "use" => "rbenv shell #{REQUIRED_RUBY_VERSION}",
  },
  "rvm" => {
    "install" => "rvm install #{REQUIRED_RUBY_VERSION}",
    "use" => "rvm #{REQUIRED_RUBY_VERSION}",
  },
  "ry" => {
    "install" => "ry install #{REQUIRED_RUBY_VERSION}",
    "use" => "eval $(ry setup); ry use #{REQUIRED_RUBY_VERSION}",
  }
}
PREFERRED_RUBY_VERSION_MANAGERS = RUBY_VERSION_MANAGER_INSTALLATION_INSTRUCTIONS.keys.reject { |key| key == "ry" }
FALLBACK_RUBY_VERSION_MANAGER = "ry"

def command_exists?(command)
  system("command -v #{command} &> /dev/null")
end

def preferred_ruby_version_manager_available?
  !!preferred_ruby_version_manager_to_use
end

def preferred_ruby_version_manager_to_use
  PREFERRED_RUBY_VERSION_MANAGERS.find do |command|
    command_exists?(command)
  end
end

def ruby_version_manager_to_use
  preferred_ruby_version_manager_to_use || FALLBACK_RUBY_VERSION_MANAGER
end

def homebrew_needs_to_be_installed?
  !command_exists?("brew")
end

def ry_needs_to_be_installed?
  !command_exists?("ry")
end

puts ""
puts "ğŸ¤– I am The Determinator! Come with me if you want to use the right Ruby version!"
puts "â„¹ï¸  Minicom uses Ruby #{REQUIRED_RUBY_VERSION}. Let me check what version of Ruby you haveâ€¦"

if REQUIRED_RUBY_VERSION == ACTUAL_RUBY_VERSION
  puts "âœ… Youâ€™re using Ruby #{ACTUAL_RUBY_VERSION}. Youâ€™re all set!"
  exit(0)
else
  puts "âš ï¸  Youâ€™re using Ruby #{ACTUAL_RUBY_VERSION}. No worries! Iâ€™ll help you install the right oneâ€¦"
end

if preferred_ruby_version_manager_available?
  puts "âœ… You have `#{preferred_ruby_version_manager_to_use}` installed! You must be a Rubyist! ğŸ’ â¤ï¸"
else
  if homebrew_needs_to_be_installed?
    puts "ğŸº Install Homebrew with `#{HOMEBREW_INSTALLATION_COMMAND}`."
  end

  if ry_needs_to_be_installed?
    puts "â›  Install ry with `#{RY_INSTALLATION_COMMAND}`."
  end
end

puts "ğŸ’ Install Ruby #{REQUIRED_RUBY_VERSION} with `#{RUBY_VERSION_MANAGER_INSTALLATION_INSTRUCTIONS[ruby_version_manager_to_use]['install']}`"
puts "ğŸ’ Switch to Ruby #{REQUIRED_RUBY_VERSION} with `#{RUBY_VERSION_MANAGER_INSTALLATION_INSTRUCTIONS[ruby_version_manager_to_use]['use']}`"
puts "ğŸ”„ Run `bin/determinator` again to double-check youâ€™re using the right Ruby version"

exit(1)
